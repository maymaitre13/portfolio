<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Admin | Ma&euml;l Maitre</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ["Space Grotesk", "ui-sans-serif", "system-ui"],
            display: ["Sora", "Space Grotesk", "ui-sans-serif"]
          },
          boxShadow: {
            card: "0 14px 36px rgba(6, 8, 24, 0.42)"
          }
        }
      }
    };
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sora:wght@500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    .bg-mesh {
      background:
        radial-gradient(1020px 540px at 24% 20%, rgba(103, 88, 255, 0.24), transparent 60%),
        radial-gradient(760px 440px at 86% 26%, rgba(66, 105, 255, 0.18), transparent 62%),
        linear-gradient(165deg, #05050b, #090a16 46%, #070711 100%);
    }
    .glass {
      background: rgba(15, 16, 32, 0.76);
      backdrop-filter: blur(6px);
    }
    .topline {
      border-bottom: 1px solid rgba(124, 126, 188, 0.2);
    }
    .panel {
      background: rgba(16, 18, 38, 0.78);
      backdrop-filter: blur(6px);
      box-shadow: 0 14px 36px rgba(6, 8, 24, 0.42);
    }
    .soft-border {
      border: 1px solid rgba(130, 138, 235, 0.16);
    }
  </style>
</head>
<body class="bg-mesh min-h-screen text-slate-100 font-sans antialiased">
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute -left-24 -top-28 h-80 w-80 rounded-full bg-indigo-500/30 blur-3xl"></div>
    <div class="absolute -right-20 top-20 h-[24rem] w-[24rem] rounded-full bg-blue-500/20 blur-3xl"></div>
    <div class="absolute bottom-[-12rem] left-1/3 h-80 w-80 rounded-full bg-violet-500/20 blur-3xl"></div>
  </div>

  <div class="relative mx-auto w-[min(1220px,calc(100%-1.2rem))] py-4">
    <header class="glass rounded-2xl px-4 py-3 shadow-card topline">
      <div class="flex items-center justify-between gap-3">
        <a href="/#home" class="flex items-center gap-3">
          <img src="{{ url_for('static', filename='images/Mael Logo.png') }}" alt="Ma&euml;l Logo" class="h-9 w-auto rounded-md object-contain" />
          <span class="text-[13px] font-semibold tracking-[0.08em] text-slate-100">MM</span>
        </a>

        <button id="menuToggle" type="button" aria-label="Open menu" aria-expanded="false" class="inline-flex items-center justify-center rounded-xl soft-border bg-indigo-500/20 p-2 text-indigo-100 lg:hidden">
          <i data-lucide="menu" class="h-5 w-5"></i>
        </button>

        <nav class="hidden items-center gap-7 text-[15px] text-slate-300 lg:flex">
          <a class="transition hover:text-white" href="/#home">Home</a>
          <a class="transition hover:text-white" href="/projects">Projects</a>
          <a class="transition hover:text-white" href="/tools">Tools</a>
          <a class="transition hover:text-white" href="/more-tools">More Tools</a>
          <a class="font-semibold text-white" href="/user-admin">User Admin</a>
          <a class="transition hover:text-white" href="/#about">About</a>
        </nav>

        <div class="hidden gap-2 lg:flex">
          <a href="/contact" class="rounded-xl soft-border bg-indigo-500/18 px-4 py-2 text-center text-sm font-semibold text-indigo-100">Contact</a>
          <a href="/logout" class="rounded-xl soft-border bg-slate-700/20 px-4 py-2 text-center text-sm font-semibold text-slate-200">Logout</a>
        </div>
      </div>

      <div id="mobileMenu" class="mt-3 hidden border-t border-indigo-300/20 pt-3 lg:hidden">
        <nav class="grid gap-2 text-sm text-slate-200">
          <a class="rounded-lg px-3 py-2 hover:bg-indigo-500/20" href="/#home">Home</a>
          <a class="rounded-lg px-3 py-2 hover:bg-indigo-500/20" href="/projects">Projects</a>
          <a class="rounded-lg px-3 py-2 hover:bg-indigo-500/20" href="/tools">Tools</a>
          <a class="rounded-lg px-3 py-2 hover:bg-indigo-500/20" href="/more-tools">More Tools</a>
          <a class="rounded-lg bg-indigo-500/20 px-3 py-2 font-semibold text-white" href="/user-admin">User Admin</a>
          <a class="rounded-lg px-3 py-2 hover:bg-indigo-500/20" href="/#about">About</a>
        </nav>
        <div class="mt-3 grid grid-cols-2 gap-2">
          <a href="/contact" class="rounded-lg soft-border bg-indigo-500/20 px-3 py-2 text-center text-sm font-semibold text-indigo-100">Contact</a>
          <a href="/logout" class="rounded-lg soft-border bg-slate-700/25 px-3 py-2 text-center text-sm font-semibold text-slate-200">Logout</a>
        </div>
      </div>
    </header>

    <main class="space-y-4 pt-2">
      <section class="panel rounded-3xl p-6 lg:p-7">
        <h1 class="font-display text-[34px] font-extrabold leading-tight text-white sm:text-[44px]">User Admin</h1>
        <p class="mt-2 text-[15px] text-slate-300">Create, update, delete, and search users. Visible only to admins.</p>

        {% if error %}
        <p class="mt-4 rounded-lg border border-rose-300/30 bg-rose-500/10 px-3 py-2 text-sm text-rose-200">{{ error }}</p>
        {% endif %}
        {% if success %}
        <p class="mt-4 rounded-lg border border-emerald-300/30 bg-emerald-500/10 px-3 py-2 text-sm text-emerald-200">{{ success }}</p>
        {% endif %}
      </section>

      <section class="panel rounded-3xl p-6 lg:p-7">
        <h2 class="font-display text-[26px] font-bold text-white">Create User</h2>
        <form method="post" action="/user-admin/create" class="mt-4 grid gap-3 md:grid-cols-2">
          <input name="username" type="text" placeholder="Username" required class="rounded-xl soft-border bg-slate-900/35 px-4 py-3 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400/45" />
          <input name="password" type="password" placeholder="Password (min 8 chars)" required class="rounded-xl soft-border bg-slate-900/35 px-4 py-3 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400/45" />
          <label class="inline-flex items-center gap-2 text-sm text-slate-200"><input type="checkbox" name="enabled" checked /> Enabled</label>
          <label class="inline-flex items-center gap-2 text-sm text-slate-200"><input type="checkbox" name="is_admin" /> Admin</label>
          <button type="submit" class="w-fit rounded-xl border border-indigo-300/40 bg-gradient-to-r from-indigo-600 to-indigo-500 px-6 py-3 text-sm font-semibold text-white">Add User</button>
        </form>
      </section>

      <section class="panel rounded-3xl p-6 lg:p-7">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
          <h2 class="font-display text-[26px] font-bold text-white">Users</h2>
          <form method="get" action="/user-admin" class="flex gap-2">
            <input name="q" value="{{ q }}" type="text" placeholder="Search username..." class="rounded-xl soft-border bg-slate-900/35 px-4 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400/45" />
            <button type="submit" class="rounded-xl border border-indigo-300/40 bg-indigo-500/20 px-4 py-2 text-sm font-semibold text-indigo-100">Search</button>
          </form>
        </div>

        <div class="mt-4 space-y-3">
          {% for user in users %}
          <form method="post" action="/user-admin/update/{{ user.id }}" class="rounded-xl bg-slate-900/35 p-4 ring-1 ring-indigo-300/12">
            <div class="grid gap-3 lg:grid-cols-[1fr_1fr_auto]">
              <input name="username" type="text" value="{{ user.username }}" required class="rounded-xl soft-border bg-slate-900/40 px-4 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400/45" />
              <input name="password" type="password" placeholder="New password (optional)" class="rounded-xl soft-border bg-slate-900/40 px-4 py-2 text-sm text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400/45" />
              <div class="flex items-center gap-3">
                <label class="inline-flex items-center gap-2 text-sm text-slate-200"><input type="checkbox" name="enabled" {% if user.enabled %}checked{% endif %}/> Enabled</label>
                <label class="inline-flex items-center gap-2 text-sm text-slate-200"><input type="checkbox" name="is_admin" {% if user.is_admin %}checked{% endif %}/> Admin</label>
              </div>
            </div>
            <div class="mt-3 flex flex-wrap items-center gap-2">
              <button type="submit" class="rounded-lg border border-indigo-300/35 bg-indigo-500/20 px-4 py-2 text-sm font-semibold text-indigo-100">Save</button>
              {% if user.id != current_user.id %}
              <button type="submit" formaction="/user-admin/delete/{{ user.id }}" formmethod="post" class="delete-user-btn rounded-lg border border-rose-300/35 bg-rose-500/15 px-4 py-2 text-sm font-semibold text-rose-100" data-username="{{ user.username }}">Delete</button>
              {% endif %}
            </div>
          </form>
          {% else %}
          <p class="text-sm text-slate-300">No users found.</p>
          {% endfor %}
        </div>
      </section>

      <section class="panel rounded-3xl p-6 lg:p-7">
        <h2 class="font-display text-[26px] font-bold text-white">Recent Sessions</h2>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full min-w-[760px] text-left text-sm">
            <thead class="text-slate-300">
              <tr>
                <th class="px-2 py-2">User</th>
                <th class="px-2 py-2">Status</th>
                <th class="px-2 py-2">Login Time</th>
                <th class="px-2 py-2">Logout Time</th>
                <th class="px-2 py-2">Login IP</th>
                <th class="px-2 py-2">Logout IP</th>
              </tr>
            </thead>
            <tbody>
              {% for s in recent_sessions %}
              <tr class="border-t border-indigo-300/12 text-slate-200">
                <td class="px-2 py-2">{{ s.username }}</td>
                <td class="px-2 py-2">{{ s.status }}</td>
                <td class="px-2 py-2">{{ s.login_at }}</td>
                <td class="px-2 py-2">{{ s.logout_at or '-' }}</td>
                <td class="px-2 py-2">{{ s.login_ip or '-' }}</td>
                <td class="px-2 py-2">{{ s.logout_ip or '-' }}</td>
              </tr>
              {% else %}
              <tr><td class="px-2 py-2 text-slate-300" colspan="6">No sessions yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section class="panel rounded-3xl p-6 lg:p-7">
        <h2 class="font-display text-[26px] font-bold text-white">Recent Auth Events</h2>
        <div class="mt-4 overflow-x-auto">
          <table class="w-full min-w-[980px] text-left text-sm">
            <thead class="text-slate-300">
              <tr>
                <th class="px-2 py-2">Time</th>
                <th class="px-2 py-2">User</th>
                <th class="px-2 py-2">Event</th>
                <th class="px-2 py-2">Status</th>
                <th class="px-2 py-2">Success</th>
                <th class="px-2 py-2">Reason</th>
                <th class="px-2 py-2">IP</th>
                <th class="px-2 py-2">Path</th>
              </tr>
            </thead>
            <tbody>
              {% for e in recent_auth_events %}
              <tr class="border-t border-indigo-300/12 text-slate-200">
                <td class="px-2 py-2">{{ e.created_at }}</td>
                <td class="px-2 py-2">{{ e.username or '-' }}</td>
                <td class="px-2 py-2">{{ e.event_type }}</td>
                <td class="px-2 py-2">{{ e.status }}</td>
                <td class="px-2 py-2">{{ 'yes' if e.success else 'no' }}</td>
                <td class="px-2 py-2">{{ e.reason or '-' }}</td>
                <td class="px-2 py-2">{{ e.ip_address or '-' }}</td>
                <td class="px-2 py-2">{{ e.request_path or '-' }}</td>
              </tr>
              {% else %}
              <tr><td class="px-2 py-2 text-slate-300" colspan="8">No auth events yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
  </div>

  <script>
    function initMobileMenu(toggleId, menuId) {
      const toggle = document.getElementById(toggleId);
      const menu = document.getElementById(menuId);
      if (!toggle || !menu) return;

      toggle.addEventListener("click", function () {
        const isHidden = menu.classList.contains("hidden");
        menu.classList.toggle("hidden", !isHidden);
        toggle.setAttribute("aria-expanded", String(isHidden));
      });

      menu.querySelectorAll("a").forEach(function (link) {
        link.addEventListener("click", function () {
          menu.classList.add("hidden");
          toggle.setAttribute("aria-expanded", "false");
        });
      });
    }

    lucide.createIcons();
    initMobileMenu("menuToggle", "mobileMenu");

    document.querySelectorAll(".delete-user-btn").forEach(function (button) {
      button.addEventListener("click", function (event) {
        const username = button.getAttribute("data-username") || "this user";
        const ok = window.confirm("Delete user '" + username + "'?");
        if (!ok) {
          event.preventDefault();
        }
      });
    });
  </script>
</body>
</html>
